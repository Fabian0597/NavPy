# TODO: Structure

- Introduction + gif of running version
- Overview /Structure (see https://github.com/dietriro/rto_core) + rqtgraph
- Packages with subscribed topics, published topics, services, config (params)
- How to run / Usage (roslaunch rto_nav..)
- Install (clone, catkin build, etc.)


# NavPy

## Introduction

## Structure/Overview

## Packages

### rto_costmap_generator
#### Description
This package contains the 'costmap_generator_node', which is used for generating the local and the global costmap. 

In order to allow the use of a point representation of the mobile robot for path planning, the static map from the map server has to be padded by the radius of the mobile robot and by an additional, optional safety distance. This leads to an area in that the robot should under no circumstances operate in. Therefore, the system will efficiently prevent the robot from crashing into obstacles that are positioned in the global costmap. This area is called the area of 'hard padding'. To additionally asign a higher cost to grid cells that are close to obstacles, a so called 'soft padding' area gets generated by the costmap generator. The robot is allowed to operate in the area but path planning through parts of the 'soft padded area' will lead to an additional cost that is taken into account by the global planner. The global costmap is a map of the type OccupancyGrid. Grid cells that are occupied by obstacles have the value 100, grid cells in the area of 'hard padding' the value 99 and grid cells in the area of 'soft padding' the values from 98 to 1. Free space is represented with the vlaue 0 and unknown space with the value -1. The following figures will represent three costmaps with the same 'hard padding' area but different types and sizes of the 'soft padding' area.

<table style="margin-left: auto; margin-right: auto; table-layout: fixed; width: 100%">
  <tr>
    <td style="width: 48%;"> <img src="resources/images/map_expo02.png"></td>
    <td style="width: 48%;"> <img src="resources/images/map_expo1.png"></td>
    <td style="width: 48%;"> <img src="resources/images/map_linear1.png"></td>
  </tr>
  <tr>
    <td style="width: 48%;" valign="top"> <b>Fig.x:</b> 'Exponential' soft padding (0.2 m).
    </td>
    <td style="width: 48%;" valign="top">  <b>Fig.x:</b> 'Exponential' soft padding (1.0 m).
    </td>
    <td style="width: 48%;" valign="top">  <b>Fig.x:</b> 'Linear' soft padding (1.0 m).
    </td>
  </tr>
</table>


In a real world scenario it is not enough to make decisions based on a static global costmap, since dynamic changes in the surrounding might lead to significant changes in the global costmap. If these changes are not recognised by the system, the accuracy of the loclization will be drastically reduced. Therefore, obstacles that are not taken into account by the current version of the global costmap have to be recognized and added in order to allow a smooth and stable navigation of the mobile robot. The local costmap serves this purpose by considering the current laserscan range measurements. The figure bellow depicts the local costmap and a obstacle that is currently not part of the global costmap. 

<table style="margin-left: auto; margin-right: auto; table-layout: fixed; width: 40%">
  <tr>
    <td style="width: 20;"> <img src="resources/images/local_costmap.png"></td>
  </tr>
  <tr>
    <td style="width: 20%;" valign="top"> <b>Fig.x:</b> Local costmap (green).
  </tr>
</table>

#### Subscribed Topics
##### `/scan`
To receive the LaserScan messages from the hokuyo laser scanner.
##### `/odom`
To receive the Odometry messages from the odometry system.

#### Published Topics
##### `/global_costmap`
To publish the OccupancyGrid of the padded global costmap.
##### `/local_costmap`
To publish the Occupancy Grid of the local costmap for visualization purpose.
##### `/local_obstacles`
To publish the PointCloud of sensed obstacles that has been transformed to the map frame.

#### Services
##### `/switch_maps`
Service that switches the static map that gets used by the costmap generator to generate the global costmap.<br>
request: map_nr_switch [int8] <br>
response: success [bool]
##### `/clear_map`
Service that resets the global costmap to its original state that only represents the padded static map. All additionally added obstacles will be deleted.<br>
request: command [string] ('clear')<br>
response: success [bool]
##### `/add_local_map`
Service that adds elements from the local_obstacle point cloud to the global costmap.<br>
request: command [string] ('stuck')<br>
response: success [bool]

#### Configuration
`init_map_nr`: Map to start the costmap generator with.<br>
`log_times`: Log execution times of critical operations.<br>
`debug_mode`: Return debugging messages to the terminal.<br>
`global_costmap`: 
- `robot_diameter`: The diameter of the robot used for 'hard padding'.
- `safety_distance`: Additional distance used for 'hard padding'.
- `padded_val`: Value of the grid elements that are part of the 'hard padding' area.
- `apply_soft_padding`: Apply the area of 'soft padding' to the global costmap.
- `decay_distane`: Distance from the area of 'hard padding' that is affected by 'soft padding'.
- `decay_type`: Decay type of the area of 'soft padding' (linear, exponential, reciprocal).
`local_costmap`:
- `length`: Width and height of the local costmap.
- `frequency`: Frequency of updating the local costmap.
- `frequency_scan`: Frequency at which the laser scanner operates.


### rto_map_server

### rto_local_planner

All other packages have been adapted from https://github.com/dietriro/rto_core and https://github.com/dietriro/rto_simulation.

## Install and how to run



### rto_map_server
This package includes a node called 'map_server'.

The map server transforms a .pgm file from the maps folder and adds meta information which is stored in the corresponding .yaml file. 
This map server also works with multiple maps.
To add a map to the map server simply append the map_server_params.yaml file in the config folder of the rto_map_server package.
Keep in mind that the syntax has to match the syntax of 'map1' and the 'maps_nr' has to be updated.

The input to the map server matches the commonly used structure from the ROS navigation stack.

To launch the map server have a look at the launch folder of this package.

#### Service 'get_map'
request: map number (int64)  
response: map (OccupancyGrid)





